---
layout: post
title: Spring JPA Hibernate - JpaRepository Insert (Batch)
category: [Spring,JPA,Java]
comments: true
---

## How does spring data internally work ?

### Add Insert Action

1. call `SimpleJpaRepository.save` (org.springframework.data.jpa.repository.support)
1. `AbstractEntityManagerImpl.persist` (org.hibernate.jpa.spi)
1. `SessionImpl.persist` (org.hibernate.internal)
1. `SessionImpl.firePersist` (org.hibernate.internal)
1. `DefaultPersistEventListener.onPersist` (org.hibernate.event.internal)
1. `DefaultPersistEventListener.entityIsTransient` (org.hibernate.event.internal)
1. `JpaPersistEventListener.saveWithGeneratedId` (org.hibernate.jpa.event.internal.core)
1. `AbstractSaveEventListener.performSave` (org.hibernate.event.internal)
1. `AbstractSaveEventListener.performSaveOrReplicate` (org.hibernate.event.internal)
1. `AbstractSaveEventListener.addInsertAction` (org.hibernate.event.internal)
1. `ActionQueue.addAction` (org.hibernate.engine.spi)
1. `ActionQueue.addInsertAction` (org.hibernate.engine.spi)
1. `ActionQueue.addResolvedEntityInsertAction` (org.hibernate.engine.spi)
1. add `EntityInsertAction` into `EXECUTABLE_LISTS_MAP.get(AbstractEntityInsertAction)`

### Real insert when tx flush

1. ` BatchingBatch.performExecution` (org.hibernate.engine.jdbc.batch.internal)
1. `PreparedStatement.executeBatchInternal` (com.mysql.jdbc): should set rewriteBatchedStatements if want to execute within batch sql
1. `PreparedStatement.executeBatchedInserts` (com.mysql.jdbc): Rewrites the already prepared statement into a multi-value insert and executes enw statement

## How to use batch in spring data JpaRepository

### Config batch size

```yml
spring:
  jpa:
    properties:
      hibernate.jdbc.batch_size: 4
```

### Rewrite INSERT statements into multi-value inserts (only for MySQL)

1. append `&rewriteBatchedStatements=true` to `spring.datasource.url`

### Verify by SQL (MySQL as example)

```bash
$ mysqld --verbose --help | grep -A 1 "Default options"
mysql> SET GLOBAL log_output = "FILE";
mysql> SET GLOBAL general_log_file = "/path/to/your/logfile.log";
mysql> SET GLOBAL general_log = 'ON';
$ tail -f /path/to/your/logfile.log
```

SQL will be like:

>     178931 16:16:16	  66 Query	SELECT 1
> 		  566 Query	SET autocommit=0
> 		  566 Query	select @@session.tx_read_only
> 		  566 Query	insert into  emp (id, name, dep) values ('1', 'clark', 'IT'),('2', 'robin', 'Market'),('3', 'jeff', 'IT'),('4', 'emily', 'HR')
